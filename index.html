<!DOCTYPE html>
<html lang="id">
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Laporan Keuangan Musholla</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary-color: #0f5132;
      --accent-color: #198754;
      --bg-color: #f0f2f5;
    }
    body { font-family: 'Poppins', sans-serif; background-color: var(--bg-color); padding-bottom: 80px; }
    
    /* Header Compact */
    .masjid-header {
      background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
      color: white; padding: 1.5rem 1rem 3rem 1rem;
      border-radius: 0 0 25px 25px; text-align: center;
      position: relative;
      z-index: 1;
    }
    
    /* Running Text Ticker (Sticky Style) */
    .ticker-container {
      background: #212529; /* Dark background */
      width: 100%;
      height: 35px;
      overflow: hidden;
      position: relative;
      margin-top: -25px; /* Pull up to overlap header slightly */
      margin-bottom: 10px;
      z-index: 2;
      border-bottom: 3px solid #ffc107; /* Gold accent line */
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .ticker-wrapper {
      display: inline-block;
      white-space: nowrap;
      padding-left: 100%; /* Start off-screen */
      animation: ticker-scroll 25s linear infinite;
    }
    .ticker-item {
      display: inline-block;
      padding: 0 20px;
      font-size: 0.85rem;
      color: white;
      line-height: 35px;
    }
    .ticker-item i { color: #ffc107; margin-right: 5px; }
    
    @keyframes ticker-scroll {
      0% { transform: translate3d(0, 0, 0); }
      100% { transform: translate3d(-100%, 0, 0); }
    }

    /* Filter Bar */
    .filter-card {
      background: white; border-radius: 15px;
      margin: 0 15px 15px 15px;
      padding: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      position: relative; z-index: 10;
    }

    /* Info Cards */
    .info-box {
      background: white; border-radius: 12px; padding: 15px;
      text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      margin-bottom: 10px;
    }
    .label-kecil { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: #888; }
    .angka-besar { font-weight: 700; font-size: 1.2rem; color: #333; }

    /* List Transaksi */
    .trans-item {
      background: white; border-radius: 10px; padding: 12px; margin-bottom: 8px;
      display: flex; justify-content: space-between; align-items: center;
      border-left: 4px solid #ccc;
    }
    .trans-masuk { border-left-color: #198754; }
    .trans-keluar { border-left-color: #dc3545; }
    .trans-barang { border-left-color: #0dcaf0; } /* Warna Cyan untuk Barang */
    .tgl-badge { font-size: 0.7rem; background: #eee; padding: 2px 6px; border-radius: 4px; }

    /* Admin & Fab */
    #adminSection { display: none; background: white; padding: 20px; border-radius: 15px; margin: 20px 15px; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); border-top: 5px solid var(--accent-color); }
    .fab { position: fixed; bottom: 20px; right: 20px; width: 56px; height: 56px; background-color: var(--primary-color); border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; z-index: 100; }
    
    .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; justify-content: center; align-items: center; z-index: 9999; }
    
    /* Style Khusus Form Keuangan Baru */
    .input-debet { border-color: #198754 !important; background-color: #f0fff4 !important; }
    .input-kredit { border-color: #dc3545 !important; background-color: #fff5f5 !important; }
    .input-debet:focus { box-shadow: 0 0 0 0.25rem rgba(25, 135, 84, 0.25) !important; }
    .input-kredit:focus { box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25) !important; }

    /* Style Dashboard Menu Grid */
    .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px; }
    .menu-item { background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 12px; padding: 20px 10px; text-align: center; cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden; }
    .menu-item:hover { background: white; border-color: var(--accent-color); box-shadow: 0 5px 15px rgba(0,0,0,0.08); transform: translateY(-3px); }
    .menu-item i { font-size: 2rem; margin-bottom: 10px; display: block; }
    .menu-item span { font-size: 0.8rem; font-weight: 600; color: #444; display: block; line-height: 1.2; }
    
    .nav-breadcrumb { display: flex; align-items: center; margin-bottom: 15px; cursor: pointer; color: #666; font-size: 0.9rem; font-weight: 600; }
    .nav-breadcrumb:hover { color: var(--primary-color); }

    /* List Donatur */
    .donatur-item { background: white; border:1px solid #eee; border-radius: 8px; padding: 10px; margin-bottom: 8px; display: flex; align-items: flex-start; }
    .avatar-char { width: 35px; height: 35px; background: #e9ecef; color: var(--primary-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 10px; flex-shrink: 0; margin-top: 2px; }

    /* Style Khusus Info Barang */
    .bg-barang { background: linear-gradient(135deg, #e0f7fa, #b2ebf2); border: 1px solid #4dd0e1; }
    
    /* Nav Tabs Custom */
    .nav-tabs .nav-link { color: #6c757d; font-weight: 600; font-size: 0.85rem; }
    .nav-tabs .nav-link.active { color: var(--primary-color); border-bottom: 3px solid var(--primary-color); }

    /* --- STYLE KHUSUS CETAK / PRINT --- */
    @media print {
        .fab, .masjid-header, .filter-card button, .nav-breadcrumb, 
        .btn-close, .nav-tabs, #reportFilters button, .d-grid, .ticker-container {
            display: none !important;
        }
        body { background-color: white; padding: 0; font-size: 12pt; }
        #adminSection { 
            display: block !important; 
            position: static; 
            box-shadow: none; 
            border: none; 
            margin: 0; 
            padding: 0;
        }
        #menuCetak::before {
            content: "LAPORAN KEUANGAN & INVENTARIS MUSHOLLA NURUL ISLAM";
            display: block;
            text-align: center;
            font-weight: bold;
            font-size: 14pt;
            margin-bottom: 5px;
            border-bottom: 2px solid black;
            padding-bottom: 10px;
        }
        #menuCetak::after {
            content: "Dicetak pada: " attr(data-print-date);
            display: block;
            text-align: right;
            font-size: 8pt;
            color: #666;
            margin-top: 20px;
        }
        #reportFilters { border: none !important; padding: 0 !important; background: none !important; }
        #reportFilters select { border: none; appearance: none; background: none; font-weight: bold; padding: 0; }
        #reportFilters label { display: inline-block; margin-right: 5px; }
        #reportPreviewArea { border: 1px solid #000 !important; box-shadow: none !important; margin-top: 10px; }
        #loginStep, #dashMenu, #menuProfil, #menuDonatur, #menuInput, #menuKasAwal { display: none !important; }
        #menuCetak { display: block !important; }
    }
  </style>
</head>
<body>

  <!-- Loading -->
  <div id="loading" class="loading-overlay">
    <div class="text-center">
      <div class="spinner-border text-success mb-2" role="status"></div>
      <div class="small text-muted" id="loadingText">Menghubungkan Server...</div>
    </div>
  </div>

  <!-- Header -->
  <header class="masjid-header">
    <h5 class="fw-bold mb-0"><i class="fas fa-mosque me-2"></i>Musholla Nurul Islam</h5>
    <small class="opacity-75" id="headerSaldo">Total Saldo: Rp 0</small>
  </header>

  <!-- Running Text / Ticker -->
  <div class="ticker-container">
      <div class="ticker-wrapper" id="newsTickerContent">
          <div class="ticker-item">Selamat Datang di Aplikasi Keuangan Musholla Nurul Islam</div>
      </div>
  </div>

  <!-- Filter Section -->
  <div class="filter-card">
    <div class="row g-2 align-items-center">
      <div class="col-4">
        <select class="form-select form-select-sm" id="filterType" onchange="updateFilterUI()">
          <option value="semua">Terbaru</option>
          <option value="harian">Harian</option>
          <option value="bulanan" selected>Bulanan</option>
          <option value="tahunan">Tahunan</option>
        </select>
      </div>
      <div class="col-8" id="filterInputContainer"></div>
    </div>
    <button class="btn btn-success btn-sm w-100 mt-2" onclick="applyFilter()">
      <i class="fas fa-search me-1"></i> Tampilkan Laporan
    </button>
  </div>

  <div class="container px-3">
    
    <!-- Ringkasan Periode -->
    <div class="row g-2 mb-2">
      <div class="col-6">
        <div class="info-box">
          <div class="label-kecil text-success">Pemasukan</div>
          <div class="angka-besar text-success" id="valMasuk">Rp 0</div>
        </div>
      </div>
      <div class="col-6">
        <div class="info-box">
          <div class="label-kecil text-danger">Pengeluaran</div>
          <div class="angka-besar text-danger" id="valKeluar">Rp 0</div>
        </div>
      </div>
      <div class="col-12">
        <div class="info-box py-2 bg-white border">
          <div class="d-flex justify-content-between align-items-center px-2">
            <span class="small text-muted">Surplus/Defisit Periode Ini:</span>
            <span class="fw-bold" id="valSelisih">Rp 0</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Ringkasan Inventaris -->
    <div class="card border-0 shadow-sm mb-4 bg-barang">
      <div class="card-body p-2 d-flex justify-content-between align-items-center">
         <div class="d-flex align-items-center">
            <div class="bg-white rounded-circle d-flex align-items-center justify-content-center me-3 shadow-sm" style="width:40px; height:40px">
                <i class="fas fa-box text-info"></i>
            </div>
            <div>
                <div class="label-kecil text-info fw-bold" style="color:#00838f;">Aset / Barang Masuk</div>
                <div class="small text-muted" style="font-size:0.7rem;">Periode Ini</div>
            </div>
         </div>
         <div class="fs-4 fw-bold text-dark" id="valBarang">0 Item</div>
      </div>
    </div>

    <!-- Riwayat List -->
    <h6 class="fw-bold mb-2 ps-1 border-start border-4 border-success">&nbsp; Rincian Transaksi</h6>
    <div id="listRiwayat"></div>
    
    <div class="text-center mt-4 mb-5 text-muted small">
      &copy; 2026 Musholla Nurul Islam <br>
      <span id="koneksiStatus" class="badge bg-secondary">Inisialisasi...</span>
    </div>
  </div>

  <!-- Admin Panel -->
  <div id="adminSection">
    <div class="d-flex justify-content-between mb-3">
      <h6 class="fw-bold text-success"><i class="fas fa-book-open"></i> Menu Bendahara</h6>
      <button class="btn btn-sm btn-close" onclick="toggleAdmin()"></button>
    </div>
    
    <!-- STEP 1: FORM LOGIN -->
    <div id="loginStep">
      <div class="text-center mb-4 mt-3">
        <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-3 shadow-sm" style="width: 70px; height: 70px;">
          <i class="fas fa-user-shield text-success fs-2"></i>
        </div>
        <h6 class="fw-bold text-dark">Login Petugas</h6>
        <p class="small text-muted mb-0">Masukkan kredensial & token akses.</p>
      </div>

      <div class="mb-3">
        <label class="small fw-bold text-muted">Username</label>
        <div class="input-group">
          <span class="input-group-text bg-light border-end-0"><i class="fas fa-user text-muted"></i></span>
          <input type="text" id="loginUser" class="form-control border-start-0 ps-0" placeholder="Username">
        </div>
      </div>
      <div class="mb-3">
        <label class="small fw-bold text-muted">Password</label>
        <div class="input-group">
          <span class="input-group-text bg-light border-end-0"><i class="fas fa-key text-muted"></i></span>
          <input type="password" id="loginPass" class="form-control border-start-0 ps-0" placeholder="Password">
        </div>
      </div>
      <div class="mb-4">
        <label class="small fw-bold text-muted">Token Validasi</label>
        <div class="input-group">
          <span class="input-group-text bg-light border-end-0"><i class="fas fa-qrcode text-muted"></i></span>
          <input type="text" id="loginToken" class="form-control border-start-0 ps-0" placeholder="Token" style="text-transform: uppercase;">
        </div>
      </div>
      
      <div class="mb-3 form-check">
        <input type="checkbox" class="form-check-input" id="checkRemember">
        <label class="form-check-label small text-muted" for="checkRemember">Ingat saya di browser ini</label>
      </div>
      
      <button class="btn btn-success w-100 fw-bold shadow-sm py-2" onclick="prosesLogin()">
        MASUK <i class="fas fa-arrow-right ms-2"></i>
      </button>
    </div>

    <!-- STEP 2: DASHBOARD -->
    <div id="inputStep" style="display:none;">
      
      <!-- Info Login User -->
      <div class="d-flex justify-content-between align-items-center mb-4 bg-light p-3 rounded-3 border">
        <div class="d-flex align-items-center">
            <div class="bg-success text-white rounded-circle me-3 d-flex align-items-center justify-content-center shadow-sm" style="width:40px; height:40px">
                <i class="fas fa-user"></i>
            </div>
            <div>
                <div class="fw-bold text-dark lh-1" id="displayUser">Bendahara</div>
                <div class="small text-muted mt-1" style="font-size: 0.75rem;">Akses Penuh</div>
            </div>
        </div>
        <button class="btn btn-sm btn-outline-danger" onclick="prosesLogout()" title="Logout">
          <i class="fas fa-power-off"></i>
        </button>
      </div>

      <!-- A. MENU GRID UTAMA -->
      <div id="dashMenu">
         <div class="text-center mb-2">
            <p class="small text-muted mb-0">Silakan pilih menu operasional:</p>
         </div>
         <div class="dashboard-grid">
            <div class="menu-item" onclick="openSubMenu('menuProfil')">
               <i class="fas fa-id-badge text-primary"></i><span>Profil<br>Petugas</span>
            </div>
            <div class="menu-item" onclick="openSubMenu('menuDonatur')">
               <i class="fas fa-users text-info"></i><span>Data<br>Donatur</span>
            </div>
            <div class="menu-item" onclick="openSubMenu('menuInput')">
               <i class="fas fa-edit text-success"></i><span>Input<br>Transaksi</span>
            </div>
            <div class="menu-item" onclick="openSubMenu('menuKasAwal')">
               <i class="fas fa-wallet text-warning"></i><span>Input<br>Kas Awal</span>
            </div>
            <div class="menu-item" onclick="openSubMenu('menuCetak')">
               <i class="fas fa-print text-danger"></i><span>Rekap &<br>Cetak</span>
            </div>
         </div>
      </div>

      <!-- SUB-MENUS -->
      
      <!-- 1. PROFIL -->
      <div id="menuProfil" class="sub-menu d-none">
         <div class="nav-breadcrumb" onclick="backToDash()"><i class="fas fa-arrow-left me-2"></i> Kembali ke Menu</div>
         <div class="card border-0 shadow-sm text-center p-4">
             <div class="mx-auto bg-light rounded-circle d-flex align-items-center justify-content-center mb-3" style="width:80px;height:80px">
                <i class="fas fa-user-tie text-secondary fs-1"></i>
             </div>
             <h5 class="fw-bold">Bendahara 101</h5>
             <p class="text-muted small mb-3">ID Petugas: MNI-BND-01</p>
             <hr>
             <div class="text-start small px-2">
                <div class="row mb-2">
                    <div class="col-5 text-muted">Jabatan</div>
                    <div class="col-7 fw-bold">Ketua Bendahara</div>
                </div>
                <div class="row mb-2">
                    <div class="col-5 text-muted">Status</div>
                    <div class="col-7 fw-bold text-success"><i class="fas fa-check-circle me-1"></i> Aktif</div>
                </div>
                <div class="row mb-2">
                    <div class="col-5 text-muted">Last Login</div>
                    <div class="col-7 text-dark" id="lastLoginTime">-</div>
                </div>
             </div>
         </div>
      </div>

      <!-- 2. DONATUR -->
      <div id="menuDonatur" class="sub-menu d-none">
          <div class="nav-breadcrumb" onclick="backToDash()"><i class="fas fa-arrow-left me-2"></i> Kembali ke Menu</div>
          <div class="d-flex justify-content-between align-items-center mb-3">
              <h6 class="fw-bold text-info mb-0"><i class="fas fa-users me-2"></i>Daftar Donatur</h6>
              <button class="btn btn-sm btn-info text-white rounded-pill px-3" onclick="toggleFormDonatur()">
                  <i class="fas fa-plus me-1"></i> Tambah
              </button>
          </div>

          <!-- Form Tambah Donatur -->
          <div id="formTambahDonatur" class="card bg-light border-0 p-3 mb-3 d-none">
              <h6 class="small fw-bold text-muted mb-2">Input Donatur Baru</h6>
              <form onsubmit="simpanDonatur(event)">
                  <div class="mb-2">
                      <input type="text" id="namaDonatur" class="form-control form-control-sm" placeholder="Nama Lengkap" required>
                  </div>
                  <div class="mb-2">
                      <input type="tel" id="hpDonatur" class="form-control form-control-sm" placeholder="No. HP / WA">
                  </div>
                  <div class="mb-2">
                      <textarea id="alamatDonatur" class="form-control form-control-sm" rows="2" placeholder="Alamat Lengkap"></textarea>
                  </div>
                  <div class="mb-2">
                      <input type="text" id="catatanDonatur" class="form-control form-control-sm" placeholder="Catatan Tambahan">
                  </div>
                  <div class="d-flex gap-2">
                      <button type="submit" class="btn btn-primary btn-sm w-100">Simpan</button>
                      <button type="button" class="btn btn-outline-secondary btn-sm w-100" onclick="toggleFormDonatur()">Batal</button>
                  </div>
              </form>
          </div>

          <div id="listDonaturContainer">
              <div class="text-center mt-3">
                 <div class="spinner-border text-info spinner-border-sm" role="status"></div>
                 <div class="small text-muted">Mengambil data...</div>
              </div>
          </div>
      </div>

      <!-- 3. INPUT TRANSAKSI -->
      <div id="menuInput" class="sub-menu d-none">
        <div class="nav-breadcrumb" onclick="backToDash()"><i class="fas fa-arrow-left me-2"></i> Kembali ke Menu</div>
        
        <form id="formKeuangan" onsubmit="handleForm(this)">
            <input type="hidden" name="username" id="hiddenUser">
            <input type="hidden" name="password" id="hiddenPass">
            <input type="hidden" name="token" id="hiddenToken">

            <div class="d-flex justify-content-between align-items-center mb-2 ps-1 border-start border-3 border-secondary">
                <h6 class="fw-bold text-secondary small mb-0">&nbsp; Input Transaksi</h6>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="switchBarang" onchange="toggleModeInput()">
                    <label class="form-check-label small text-muted fw-bold" for="switchBarang">Mode Barang</label>
                </div>
            </div>
            
            <div class="row g-2 mb-2">
              <div class="col-5">
                <label class="small text-muted">Tanggal</label>
                <input type="date" class="form-control form-control-sm" name="tanggal" id="inputTanggal" required>
              </div>
              <div class="col-7">
                <label class="small text-muted">Kategori Pos</label>
                <select class="form-select form-select-sm" name="kategori" id="selectKategori" onchange="cekOpsiKategori(this.value)" required>
                    <option value="" disabled selected>Pilih Kategori...</option>
                </select>
              </div>
            </div>

            <div id="areaKategoriLain" class="d-none mb-2">
                <label class="small text-primary fw-bold">Nama Kategori Baru</label>
                <input type="text" class="form-control form-control-sm border-primary" id="inputKategoriLain" placeholder="Tulis nama kategori">
            </div>

            <div id="areaDonatur" class="d-none mb-2 p-2 bg-light border rounded">
                <label class="small text-muted mb-1 d-flex justify-content-between">
                    <span>Pilih Donatur</span>
                    <a href="#" onclick="openSubMenu('menuDonatur')" class="text-decoration-none fw-bold text-info" style="font-size: 0.7rem;">+ Data Baru</a>
                </label>
                <select class="form-select form-select-sm border-info" name="donatur_id" id="inputDonatur">
                    <option value="Hamba Allah">Hamba Allah (Anonim)</option>
                </select>
            </div>
            
            <div id="inputSectionBarang" class="d-none bg-light p-2 rounded border mb-2">
                <div class="mb-2">
                    <label class="small text-muted fw-bold">Nama Barang / Logistik</label>
                    <input type="text" class="form-control form-control-sm" id="inputNamaBarang" placeholder="Contoh: Air Mineral">
                </div>
                <div class="row g-2">
                    <div class="col-6">
                        <label class="small text-muted">Jumlah</label>
                        <input type="text" class="form-control form-control-sm" id="inputJmlBarang" placeholder="Contoh: 5 Dus">
                    </div>
                    <div class="col-6">
                        <label class="small text-muted">Est. Nilai (Rp)</label>
                        <input type="number" class="form-control form-control-sm" id="inputEstHarga" placeholder="0">
                    </div>
                </div>
            </div>

            <div class="mb-2">
              <label class="small text-muted">Uraian / Keterangan</label>
              <textarea class="form-control form-control-sm" name="keterangan" rows="2" placeholder="Contoh: Sumbangan untuk acara..." required></textarea>
            </div>

            <div class="mb-2">
                <label class="small text-muted">Upload Bukti / Nota (Opsional)</label>
                <input type="file" class="form-control form-control-sm" id="inputBukti" accept="image/jpeg, image/png">
            </div>
            
            <div id="inputSectionUang">
                <div class="row g-2 mb-3">
                  <div class="col-6">
                    <label class="small fw-bold text-success">DEBET (Masuk)</label>
                    <div class="input-group input-group-sm">
                      <span class="input-group-text bg-success text-white border-success">Rp</span>
                      <input type="number" class="form-control input-debet fw-bold" id="inputDebet" name="debet" placeholder="0" oninput="cekPosisi('debet')">
                    </div>
                  </div>
                  <div class="col-6">
                    <label class="small fw-bold text-danger">KREDIT (Keluar)</label>
                    <div class="input-group input-group-sm">
                      <span class="input-group-text bg-danger text-white border-danger">Rp</span>
                      <input type="number" class="form-control input-kredit fw-bold" id="inputKredit" name="kredit" placeholder="0" oninput="cekPosisi('kredit')">
                    </div>
                  </div>
                </div>
            </div>

            <button type="submit" class="btn btn-primary btn-sm w-100 py-2 fw-bold shadow-sm" id="btnSimpan">
              <i class="fas fa-paper-plane me-1"></i> POSTING JURNAL
            </button>
        </form>
      </div>

      <!-- 4. KAS AWAL -->
      <div id="menuKasAwal" class="sub-menu d-none">
        <div class="nav-breadcrumb" onclick="backToDash()"><i class="fas fa-arrow-left me-2"></i> Kembali ke Menu</div>
        <div class="card border-0 shadow-sm p-3">
            <h6 class="fw-bold text-warning mb-3"><i class="fas fa-coins me-2"></i>Setup Saldo Awal</h6>
            <form onsubmit="handleKasAwal(event)">
                <div class="mb-3">
                    <label class="small text-muted">Tanggal Saldo</label>
                    <input type="date" class="form-control" id="inputTglSaldo" required>
                </div>
                <div class="mb-3">
                    <label class="small text-muted">Nominal Saldo (Rp)</label>
                    <input type="number" class="form-control fw-bold" id="inputJmlSaldo" required>
                </div>
                <button type="submit" class="btn btn-warning w-100 text-white fw-bold" id="btnSimpanSaldo">SIMPAN SALDO AWAL</button>
            </form>
        </div>
      </div>

      <!-- 5. REKAP & CETAK -->
      <div id="menuCetak" class="sub-menu d-none">
        <div class="nav-breadcrumb" onclick="backToDash()"><i class="fas fa-arrow-left me-2"></i> Kembali ke Menu</div>
        <div class="card border-0 shadow-sm p-3">
            <h6 class="fw-bold text-dark mb-3"><i class="fas fa-file-invoice-dollar me-2"></i>Pusat Laporan</h6>
            
            <ul class="nav nav-tabs nav-fill small mb-3" id="tabLaporan" role="tablist">
                <li class="nav-item"><button class="nav-link active fw-bold" id="tab-keuangan" onclick="switchReportTab('keuangan')" type="button">Keuangan</button></li>
                <li class="nav-item"><button class="nav-link fw-bold" id="tab-inventaris" onclick="switchReportTab('inventaris')" type="button">Inventaris</button></li>
            </ul>

            <div id="viewKeuangan">
                <div class="mb-3">
                    <label class="small text-muted fw-bold">Jenis Laporan</label>
                    <select class="form-select form-select-sm mb-2" id="reportType" onchange="updateReportForm()">
                        <option value="bulanan">Laporan Umum - Per Bulan</option>
                        <option value="tahunan">Laporan Umum - Per Tahun</option>
                        <option value="kategori_bulan">Detail Kategori - Per Bulan</option>
                        <option value="kategori_tahun">Detail Kategori - Per Tahun</option>
                        <option value="donatur">Riwayat Donatur (Per Tahun)</option>
                    </select>
                </div>

                <div id="reportFilters" class="bg-light p-2 rounded mb-3 border">
                    <div id="filterBulan" class="mb-2">
                        <label class="small text-muted">Pilih Periode</label>
                        <div class="input-group input-group-sm">
                            <select id="rpt_bln" class="form-select">
                               <option value="1">Januari</option><option value="2">Februari</option><option value="3">Maret</option>
                               <option value="4">April</option><option value="5">Mei</option><option value="6">Juni</option>
                               <option value="7">Juli</option><option value="8">Agustus</option><option value="9">September</option>
                               <option value="10">Oktober</option><option value="11">November</option><option value="12">Desember</option>
                            </select>
                            <select id="rpt_thn_bln" class="form-select" style="max-width: 80px;"></select>
                        </div>
                    </div>
                    <div id="filterTahun" class="mb-2 d-none">
                        <label class="small text-muted">Pilih Tahun</label>
                        <select id="rpt_thn_only" class="form-select form-select-sm"></select>
                    </div>
                    <div id="filterKategori" class="mb-2 d-none">
                        <label class="small text-muted">Pilih Kategori</label>
                        <select id="rpt_kategori" class="form-select form-select-sm"></select>
                    </div>
                    <div id="filterDonatur" class="mb-2 d-none">
                        <label class="small text-muted">Pilih Donatur</label>
                        <select id="rpt_donatur" class="form-select form-select-sm"></select>
                    </div>
                    <button class="btn btn-secondary btn-sm w-100 mt-2" onclick="generateReportPreview()">
                        <i class="fas fa-sync me-1"></i> Tampilkan Preview
                    </button>
                </div>
            </div>

            <div id="viewInventaris" class="d-none">
                <div class="bg-light p-2 rounded mb-3 border">
                    <label class="small text-muted fw-bold mb-2">Laporan Barang Masuk</label>
                    <label class="small text-muted">Pilih Tahun</label>
                    <select id="rpt_inv_thn" class="form-select form-select-sm mb-2"></select>
                    <button class="btn btn-info text-white btn-sm w-100" onclick="generateInventoryPreview()">
                        <i class="fas fa-box-open me-1"></i> Cek Aset Barang
                    </button>
                </div>
            </div>

            <div id="reportPreviewArea" class="border rounded p-2 mb-3 bg-white" style="min-height: 80px;">
                <p class="text-center text-muted small my-3"><em>Silakan atur filter dan klik 'Tampilkan Preview'</em></p>
            </div>

            <div class="d-grid gap-2">
                <button class="btn btn-dark" onclick="alert('Fitur download PDF memerlukan backend yang aktif.')"><i class="fas fa-file-pdf me-2"></i> Download PDF</button>
                <button class="btn btn-outline-dark" onclick="window.print()"><i class="fas fa-print me-2"></i> Cetak</button>
            </div>
        </div>
      </div>

    </div>
  </div>

  <div class="fab" onclick="toggleAdmin()"><i class="fas fa-user-cog"></i></div>

  <script>
    // --- KONFIGURASI API UTAMA ---
    const APP_URL = "https://script.google.com/macros/s/AKfycbwycwKcMd8NXBKZKoW71utLG3GoRZXXQV6dfT1Ki0r7YJgq6sUzZm4dPit1DZRJUfgw-Q/exec";

    // FUNGSI PENGHUBUNG (Bridge) - UPDATED FOR ROBUSTNESS
    function callAPI(action, params = {}, method = 'GET') {
        return new Promise((resolve, reject) => {
            const statusEl = document.getElementById('koneksiStatus');
            
            // 1. Cek: Internal GAS
            if (typeof google !== 'undefined' && typeof google.script !== 'undefined') {
                if(statusEl) { statusEl.innerText = "Terhubung: Internal App"; statusEl.className = "badge bg-success"; }
                google.script.run
                    .withSuccessHandler(resolve)
                    .withFailureHandler(reject)
                    [action](params);
            } 
            // 2. Cek: Eksternal Web App
            else if (APP_URL) {
                let url = APP_URL;
                const options = { method: "POST" }; 
                const payload = { action: action, data: params };

                options.body = JSON.stringify(payload);
                options.headers = { "Content-Type": "text/plain;charset=utf-8" };

                // Gunakan fetch dengan penanganan error jaringan yang lebih baik
                fetch(url, options)
                    .then(response => {
                        if (!response.ok) throw new Error("Network response was not ok: " + response.status);
                        return response.json();
                    })
                    .then(json => {
                        if(statusEl) { statusEl.innerText = "Terhubung"; statusEl.className = "badge bg-success"; }
                        if(json.error) reject(json.error);
                        else resolve(json.result || json); 
                    })
                    .catch(err => {
                        // WARN saja, jangan ERROR agar console tidak merah
                        console.warn("Koneksi API Gagal/Terblokir, beralih ke Mode Offline.", err);
                        
                        if(statusEl) { statusEl.innerText = "Mode Offline"; statusEl.className = "badge bg-secondary"; }
                        
                        // Reject dengan kode khusus untuk memicu fallback
                        reject("OFFLINE_MODE");
                    });
            } 
            // 3. Fallback: Offline
            else {
                reject("OFFLINE_MODE");
            }
        });
    }

    // --- VARIABEL & INIT ---
    const today = new Date();
    const curMonth = today.getMonth() + 1;
    const curYear = today.getFullYear();
    const curDateStr = today.toISOString().split('T')[0];
    
    let globalDonaturs = [];
    
    // Data Dummy untuk Mode Offline
    let localTransactions = [
        {tanggal: curDateStr, ket: 'Saldo Awal (Simulasi Mode Offline)', nominal: 1000000, tipe: 'masuk', kategori: 'Kas Awal'},
        {tanggal: curDateStr, ket: 'Infaq Jumat (Contoh)', nominal: 500000, tipe: 'masuk', kategori: 'Infaq Jumat'},
        {tanggal: curDateStr, ket: 'Beli Token Listrik (Contoh)', nominal: 100000, tipe: 'keluar', kategori: 'Operasional'}
    ];
    
    const kategoriBawaan = [
      { nama: "Infaq Jumat", grup: "Pemasukan" }, { nama: "Infaq Pembangunan", grup: "Pemasukan" },
      { nama: "Donasi Tetap", grup: "Pemasukan" }, { nama: "Wakaf Tunai", grup: "Pemasukan" },
      { nama: "Operasional Listrik & Air", grup: "Pengeluaran" }, { nama: "Honorarium Marbot", grup: "Pengeluaran" },
      { nama: "Perlengkapan Kebersihan", grup: "Pengeluaran" }, { nama: "Konsumsi Kegiatan", grup: "Pengeluaran" }
    ];

    window.onload = function() {
      document.getElementById('inputTanggal').value = curDateStr;
      document.getElementById('inputTglSaldo').value = curDateStr; // Init tgl saldo
      
      const savedUser = localStorage.getItem('mk_user');
      const savedPass = localStorage.getItem('mk_pass');
      const savedToken = localStorage.getItem('mk_token');
      
      if(savedUser && savedPass && savedToken) {
          document.getElementById('loginUser').value = savedUser;
          document.getElementById('loginPass').value = savedPass;
          document.getElementById('loginToken').value = savedToken;
          document.getElementById('checkRemember').checked = true;
      }
      
      initReportDropdowns();
      updateFilterUI(); 
      applyFilter(); 
      loadDonaturs();
      loadKategoriServer();
    };

    // --- LOGIKA UTAMA ---

    function loadKategoriServer() {
      callAPI('getRiwayatKategori')
        .then(data => renderKategoriDropdown(data))
        .catch(err => {
            // Fallback silent
            renderKategoriDropdown([]); 
        });
    }

    function renderKategoriDropdown(riwayatKats) {
      const select = document.getElementById('selectKategori');
      select.innerHTML = '<option value="" disabled selected>Pilih Kategori...</option>';
      
      let htmlMasuk = '<optgroup label="Pemasukan (Standar)">';
      kategoriBawaan.filter(k => k.grup === 'Pemasukan').forEach(k => htmlMasuk += `<option value="${k.nama}">${k.nama}</option>`);
      htmlMasuk += '</optgroup>';
      
      let htmlKeluar = '<optgroup label="Pengeluaran (Standar)">';
      kategoriBawaan.filter(k => k.grup === 'Pengeluaran').forEach(k => htmlKeluar += `<option value="${k.nama}">${k.nama}</option>`);
      htmlKeluar += '</optgroup>';
      
      let tambahan = '';
      if(Array.isArray(riwayatKats)) {
          riwayatKats.forEach(k => {
             if(!kategoriBawaan.some(b => b.nama === k.nama)) {
                tambahan += `<option value="${k.nama}">${k.nama} (Riwayat)</option>`;
             }
          });
      }
      
      select.innerHTML += htmlMasuk + htmlKeluar + (tambahan ? `<optgroup label="Lainnya">${tambahan}</optgroup>` : '') + '<option value="Lainnya" class="fw-bold text-primary">-- Lainnya (Buat Baru) --</option>';
    }

    function loadDonaturs() {
      callAPI('getDonaturs')
        .then(data => {
            globalDonaturs = data;
            renderListDonatur(data);
            updateDropdownDonatur(data);
        })
        .catch(err => {
            // Simulasi Offline (Silent)
            globalDonaturs = [{id: 1, nama: "H. Abdullah (Offline)", hp: "081-OFFLINE", alamat: "Mode Offline", catatan: "Data Contoh"}];
            renderListDonatur(globalDonaturs);
            updateDropdownDonatur(globalDonaturs);
        });
    }

    function simpanDonatur(e) {
        e.preventDefault();
        const nama = document.getElementById('namaDonatur').value;
        const hp = document.getElementById('hpDonatur').value;
        const alamat = document.getElementById('alamatDonatur').value;
        const catatan = document.getElementById('catatanDonatur').value;
        const btn = e.target.querySelector('button[type="submit"]');

        btn.disabled = true; btn.innerText = 'Menyimpan...';

        const dataKirim = { nama, hp, alamat, catatan };

        callAPI('tambahDonatur', dataKirim)
            .then(newData => {
               globalDonaturs = newData;
               renderListDonatur(newData);
               updateDropdownDonatur(newData);
               toggleFormDonatur();
               alert("Donatur Tersimpan!");
               document.getElementById('formTambahDonatur').querySelector('form').reset();
            })
            .catch(err => {
               // Fallback Local
               alert("Koneksi Server Gagal: Data donatur tidak tersimpan permanen.");
               toggleFormDonatur();
            })
            .finally(() => {
               btn.disabled = false; btn.innerText = 'Simpan';
            });
    }

    // --- FORM TRANSAKSI ---
    function handleForm(form) {
      event.preventDefault();
      
      // Validasi Input
      const isBarang = document.getElementById('switchBarang').checked;
      let valDebet = document.getElementById('inputDebet').value;
      let valKredit = document.getElementById('inputKredit').value;
      
      if(!isBarang && !valDebet && !valKredit) { alert("Isi nominal Debet atau Kredit!"); return; }

      // Cek File
      const fileInput = document.getElementById('inputBukti');
      if (fileInput.files.length > 0 && fileInput.files[0].size > 2 * 1024 * 1024) {
         alert("File max 2MB!"); return;
      }

      const btn = document.getElementById('btnSimpan');
      btn.disabled = true; btn.innerText = "Mengirim ke Server...";

      // Prepare Data
      const prepareAndSubmit = (fileData) => {
          let nominal = 0;
          let jenis = '';
          let ket = form.keterangan.value;
          let kat = form.kategori.value;

          if (isBarang) {
              const nmBrg = document.getElementById('inputNamaBarang').value;
              const jmlBrg = document.getElementById('inputJmlBarang').value;
              ket = `[BARANG] ${nmBrg} (${jmlBrg}) - ${ket}`;
              jenis = 'masuk'; // Asset masuk
              nominal = document.getElementById('inputEstHarga').value || 0;
          } else {
              if (valDebet) { nominal = valDebet; jenis = 'masuk'; }
              else { nominal = valKredit; jenis = 'keluar'; }
          }

          if (kat === 'Lainnya') kat = document.getElementById('inputKategoriLain').value;
          
          const donaturId = (!document.getElementById('areaDonatur').classList.contains('d-none')) 
                            ? document.getElementById('inputDonatur').value : "";

          const formData = {
            username: form.username.value,
            password: form.password.value,
            token: form.token.value,
            tanggal: form.tanggal.value,
            kategori: kat,
            keterangan: ket + (donaturId ? ` (Donatur: ${donaturId})` : ''),
            jenis: jenis,
            nominal: parseInt(nominal),
            donatur_id: donaturId,
            file_bukti: fileData 
          };

          callAPI('prosesInput', formData)
            .then(res => {
                alert(res.message || "Berhasil Disimpan!");
                form.reset();
                document.getElementById('inputTanggal').value = curDateStr;
                applyFilter(); // Refresh Data
                backToDash();
            })
            .catch(err => {
                if(err === "OFFLINE_MODE") {
                    // Simpan Lokal untuk Demo
                    localTransactions.push({
                        tanggal: formData.tanggal, 
                        ket: formData.keterangan, 
                        nominal: formData.nominal, 
                        tipe: formData.jenis
                    });
                    
                    alert("Mode Offline: Data disimpan secara LOKAL SEMENTARA (Akan hilang jika di-refresh).");
                    form.reset();
                    applyFilter();
                    backToDash();
                } else {
                    alert("Gagal: " + err);
                }
            })
            .finally(() => {
                btn.disabled = false; btn.innerHTML = `<i class="fas fa-paper-plane me-1"></i> POSTING JURNAL`;
            });
      };

      if (fileInput.files.length > 0) {
          const reader = new FileReader();
          reader.onload = function(e) {
              const result = e.target.result; 
              const filePayload = {
                  data: result.split(',')[1],
                  mimeType: result.split(';')[0].split(':')[1],
                  name: fileInput.files[0].name
              };
              prepareAndSubmit(filePayload);
          };
          reader.readAsDataURL(fileInput.files[0]);
      } else {
          prepareAndSubmit(null);
      }
    }

    function applyFilter() {
      document.getElementById('loading').style.display = 'flex';
      
      const type = document.getElementById('filterType').value;
      let filter = { jenis: type };

      if(type === 'harian') filter.tgl = document.getElementById('f_tgl').value;
      else if(type === 'bulanan') {
        filter.bln = parseInt(document.getElementById('f_bln').value);
        filter.thn = parseInt(document.getElementById('f_thn').value);
      } else if(type === 'tahunan') {
        filter.thn = parseInt(document.getElementById('f_thn_only').value);
      }

      callAPI('getLaporanFiltered', filter)
        .then(renderData)
        .catch(err => {
            // Simulasi Render Offline (Smooth Fallback)
            console.log("Rendering Offline Data...");
            setTimeout(() => {
                let saldo = 0, masuk = 0, keluar = 0;
                // Hitung dari localTransactions
                let data = JSON.parse(JSON.stringify(localTransactions)).reverse(); // Clone & Reverse
                
                data.forEach(t => {
                   if(t.tipe === 'masuk') { saldo += t.nominal; masuk += t.nominal; }
                   else { saldo -= t.nominal; keluar += t.nominal; }
                });
                
                renderData({saldoTotal: saldo, masukPeriode: masuk, keluarPeriode: keluar, riwayat: data});
            }, 300); // Sedikit delay agar loading terasa
        });
    }

    // --- RENDER & UTILS ---
    const formatRupiah = (n) => new Intl.NumberFormat('id-ID', {style:'currency', currency:'IDR', minimumFractionDigits:0}).format(n);

    function renderData(data) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('headerSaldo').innerText = "Total Saldo: " + formatRupiah(data.saldoTotal);
      document.getElementById('valMasuk').innerText = formatRupiah(data.masukPeriode);
      document.getElementById('valKeluar').innerText = formatRupiah(data.keluarPeriode);
      
      const selisih = data.masukPeriode - data.keluarPeriode;
      const elSelisih = document.getElementById('valSelisih');
      elSelisih.innerText = formatRupiah(selisih);
      elSelisih.className = selisih >= 0 ? "fw-bold text-success" : "fw-bold text-danger";

      let html = '';
      let countBarang = 0;
      
      if(!data.riwayat || data.riwayat.length === 0) {
        html = '<div class="text-center text-muted py-4 small">Tidak ada transaksi.</div>';
      } else {
        data.riwayat.forEach(item => {
          const isBarang = item.ket.includes('[BARANG]');
          if(isBarang) countBarang++;
          const isMasuk = item.tipe === 'masuk';
          
          let borderClass = isBarang ? 'trans-barang' : (isMasuk ? 'trans-masuk' : 'trans-keluar');
          let nominalClass = isBarang ? 'text-info' : (isMasuk ? 'text-success' : 'text-danger');
          let nominalText = isBarang 
              ? (item.nominal > 0 ? formatRupiah(item.nominal) : 'Aset Non-Tunai') 
              : ((isMasuk ? '+' : '-') + ' ' + formatRupiah(Math.abs(item.nominal)));
          
          let displayKet = isBarang ? item.ket.replace('[BARANG]', '').trim() : item.ket;
          let icon = isBarang ? '<i class="fas fa-box text-info me-1"></i> ' : '';

          html += `
            <div class="trans-item ${borderClass}">
              <div style="width: 65%">
                <span class="tgl-badge">${item.tanggal}</span>
                <div class="fw-bold text-dark mt-1 text-truncate">${icon}${displayKet}</div>
              </div>
              <div class="text-end" style="width: 35%">
                <div class="fw-bold ${nominalClass}" style="font-size:0.9rem">${nominalText}</div>
              </div>
            </div>`;
        });
      }
      document.getElementById('listRiwayat').innerHTML = html;
      document.getElementById('valBarang').innerText = countBarang + " Item";
      updateTicker(data.riwayat || []);
    }

    function updateTicker(riwayat) {
      const container = document.getElementById('newsTickerContent');
      const incomeList = riwayat.filter(x => x.tipe === 'masuk').slice(0, 5);
      if(incomeList.length === 0) return;
      
      let html = '';
      incomeList.forEach(item => {
         let name = "Hamba Allah";
         const match = item.ket.match(/\(Donatur: (.*?)\)/);
         if(match) name = match[1];
         html += `<div class="ticker-item"><i class="fas fa-heart"></i> Terima Kasih <b>${name}</b> - ${item.tanggal} &nbsp;&bull;&nbsp;</div>`;
      });
      container.innerHTML = html;
    }

    // --- UI HELPERS ---
    function updateFilterUI() {
      const type = document.getElementById('filterType').value;
      const container = document.getElementById('filterInputContainer');
      let html = '';

      if(type === 'harian') {
        html = `<input type="date" id="f_tgl" class="form-control form-control-sm" value="${curDateStr}">`;
      } else if(type === 'bulanan') {
        html = `<div class="input-group input-group-sm">
            <select id="f_bln" class="form-select">${[...Array(12).keys()].map(i => `<option value="${i+1}" ${curMonth==i+1?'selected':''}>${new Date(0,i).toLocaleString('id',{month:'short'})}</option>`).join('')}</select>
            <select id="f_thn" class="form-select"><option value="${curYear}">${curYear}</option><option value="${curYear-1}">${curYear-1}</option></select>
          </div>`;
      } else if(type === 'tahunan') {
        html = `<select id="f_thn_only" class="form-select form-select-sm"><option value="${curYear}">${curYear}</option><option value="${curYear-1}">${curYear-1}</option></select>`;
      }
      container.innerHTML = html;
    }

    function renderListDonatur(data) {
        const container = document.getElementById('listDonaturContainer');
        if(!data || data.length === 0) { container.innerHTML = '<div class="text-center text-muted small">Belum ada data.</div>'; return; }
        container.innerHTML = data.map(d => `
            <div class="donatur-item justify-content-between">
                <div class="d-flex">
                    <div class="avatar-char mt-1">${d.nama.charAt(0).toUpperCase()}</div>
                    <div><div class="fw-bold small">${d.nama}</div><div class="text-muted" style="font-size:0.7rem">${d.hp||'-'}</div></div>
                </div>
                <button class="btn btn-sm text-danger" onclick="alert('Fitur hapus dinonaktifkan di demo ini.')"><i class="fas fa-trash"></i></button>
            </div>`).join('');
    }

    function updateDropdownDonatur(data) {
        const select = document.getElementById('inputDonatur');
        select.innerHTML = '<option value="Hamba Allah">Hamba Allah (Anonim)</option>';
        if(data) data.forEach(d => select.innerHTML += `<option value="${d.nama}">${d.nama}</option>`);
    }

    function cekOpsiKategori(val) {
        const areaDonatur = document.getElementById('areaDonatur');
        if(['Infaq Pembangunan','Donasi Tetap','Wakaf Tunai'].includes(val) || val.toLowerCase().includes('infaq')) areaDonatur.classList.remove('d-none');
        else areaDonatur.classList.add('d-none');
        
        const areaLain = document.getElementById('areaKategoriLain');
        if(val === 'Lainnya') { areaLain.classList.remove('d-none'); document.getElementById('inputKategoriLain').required=true; }
        else { areaLain.classList.add('d-none'); document.getElementById('inputKategoriLain').required=false; }
    }

    function toggleModeInput() {
        const isBarang = document.getElementById('switchBarang').checked;
        if(isBarang) {
            document.getElementById('inputSectionUang').classList.add('d-none');
            document.getElementById('inputSectionBarang').classList.remove('d-none');
        } else {
            document.getElementById('inputSectionUang').classList.remove('d-none');
            document.getElementById('inputSectionBarang').classList.add('d-none');
        }
    }

    function cekPosisi(mode) {
      const d = document.getElementById('inputDebet'), k = document.getElementById('inputKredit');
      if (mode === 'debet' && d.value) { k.value=''; k.disabled=true; }
      else if (mode === 'kredit' && k.value) { d.value=''; d.disabled=true; }
      else { d.disabled=false; k.disabled=false; }
    }

    // --- LOGIN/NAV SYSTEM ---
    function prosesLogin() {
      const u = document.getElementById('loginUser').value;
      const p = document.getElementById('loginPass').value;
      const t = document.getElementById('loginToken').value;

      if (u !== "bendahara101" || p !== "MNI8823" || t.toUpperCase() !== "UMAT") { alert("Login Gagal!"); return; }

      if(document.getElementById('checkRemember').checked) {
        localStorage.setItem('mk_user', u); localStorage.setItem('mk_pass', p); localStorage.setItem('mk_token', t);
      }
      document.getElementById('hiddenUser').value = u; document.getElementById('hiddenPass').value = p; document.getElementById('hiddenToken').value = t;
      document.getElementById('displayUser').innerText = u;
      document.getElementById('loginStep').style.display = 'none'; document.getElementById('inputStep').style.display = 'block';
      backToDash(); 
    }

    function prosesLogout() {
      localStorage.clear();
      location.reload();
    }

    function toggleAdmin() { const s = document.getElementById('adminSection'); s.style.display = s.style.display==='block'?'none':'block'; if(s.style.display==='block') s.scrollIntoView(); }
    function openSubMenu(id) { document.getElementById('dashMenu').classList.add('d-none'); document.querySelectorAll('.sub-menu').forEach(e=>e.classList.add('d-none')); document.getElementById(id).classList.remove('d-none'); if(id==='menuCetak') updateReportForm(); }
    function backToDash() { document.querySelectorAll('.sub-menu').forEach(e=>e.classList.add('d-none')); document.getElementById('dashMenu').classList.remove('d-none'); }
    function toggleFormDonatur() { document.getElementById('formTambahDonatur').classList.toggle('d-none'); }
    function initReportDropdowns() { /* Init dropdon logic similar to original */ }
    function switchReportTab(t) { 
        document.getElementById('viewKeuangan').classList.add('d-none'); document.getElementById('viewInventaris').classList.add('d-none');
        document.getElementById('tab-keuangan').classList.remove('active'); document.getElementById('tab-inventaris').classList.remove('active');
        if(t==='keuangan'){ document.getElementById('viewKeuangan').classList.remove('d-none'); document.getElementById('tab-keuangan').classList.add('active'); }
        else { document.getElementById('viewInventaris').classList.remove('d-none'); document.getElementById('tab-inventaris').classList.add('active'); }
    }
    function updateReportForm() {
        const t = document.getElementById('reportType').value;
        ['filterBulan','filterTahun','filterKategori','filterDonatur'].forEach(id=>document.getElementById(id).classList.add('d-none'));
        if(t==='bulanan') document.getElementById('filterBulan').classList.remove('d-none');
        if(t==='tahunan') document.getElementById('filterTahun').classList.remove('d-none');
        if(t.includes('kategori')) { document.getElementById('filterKategori').classList.remove('d-none'); if(t.includes('bulan')) document.getElementById('filterBulan').classList.remove('d-none'); else document.getElementById('filterTahun').classList.remove('d-none'); }
        if(t==='donatur') { document.getElementById('filterDonatur').classList.remove('d-none'); document.getElementById('filterTahun').classList.remove('d-none'); }
        // Populate dropdowns logic here...
    }
    function generateReportPreview() { document.getElementById('reportPreviewArea').innerHTML = '<div class="text-center text-info small">Preview akan muncul di sini (Simulasi).</div>'; }
    function generateInventoryPreview() { document.getElementById('reportPreviewArea').innerHTML = '<div class="text-center text-info small">List Barang (Simulasi).</div>'; }
    
    // FUNGSI HANDLE KAS AWAL YANG DIPERBAIKI
    function handleKasAwal(e) {
        e.preventDefault();
        
        const tgl = document.getElementById('inputTglSaldo').value;
        const jml = document.getElementById('inputJmlSaldo').value;
        const user = document.getElementById('hiddenUser').value || 'Bendahara';
        const token = document.getElementById('hiddenToken').value;

        if(!tgl || !jml) { alert("Mohon lengkapi data!"); return; }

        const btn = document.getElementById('btnSimpanSaldo');
        btn.disabled = true; btn.innerText = "Menyimpan...";

        const data = {
            username: user,
            token: token,
            tanggal: tgl,
            kategori: "Saldo Awal",
            keterangan: "Saldo Awal Pembukuan",
            jenis: "masuk",
            nominal: parseInt(jml),
            donatur_id: "-"
        };

        callAPI('prosesInput', data)
            .then(res => {
                alert("Saldo Awal Berhasil Disimpan!");
                // Reset form jika perlu
                document.getElementById('inputJmlSaldo').value = "";
                applyFilter(); // Refresh dashboard agar saldo berubah
                backToDash();
            })
            .catch(err => {
                alert("Gagal: " + err);
            })
            .finally(() => {
                btn.disabled = false; btn.innerText = "SIMPAN SALDO AWAL";
            });
    }
  </script>
</body>
</html>
